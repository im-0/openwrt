os:
  - linux

sudo: required
dist: trusty

before_script:
  - sudo apt-get -qq update
  - sudo apt-get -qq install build-essential subversion libncurses5-dev zlib1g-dev gawk gcc-multilib flex git gettext libssl-dev unzip wget python2.7 time xz-utils
  - sudo apt-get -qq purge file libmagic1 || true

  - wget -q -c -t 0 -T 15 "https://fossies.org/linux/misc/file-5.34.tar.gz"
  - tar xf file-5.34.tar.gz
  - cd file-5.34
  - ./configure --prefix=/usr --sysconfdir=/etc >/dev/null 2>&1
  - make -j2 >/dev/null 2>&1
  - sudo make install >/dev/null 2>&1
  - cd .. && rm -fr file-5.34

script:
  - ./scripts/feeds update -a
  - ./scripts/feeds install -a

  - cp -v ./my-config ./.config
  - cp -rv ./my-files ./files

  - cp -rv ./my-dl ./dl
  - make download

  # Output something every 10 minutes or Travis kills the job
  - while sleep 9m; do echo "=====[ still running ]====="; done &
  - make -j2 </dev/null 2>&1 | tee
  # Killing background sleep loop
  - kill %1

  - echo
  - ls -lh ./bin/targets/ar71xx/generic/*.bin
  - echo
  - sha512sum ./bin/targets/ar71xx/generic/*.bin
  - echo

  - curl --upload-file ./bin/targets/ar71xx/generic/openwrt-ar71xx-generic-tl-wr1043nd-v1-squashfs-factory.bin https://transfer.sh/openwrt-ar71xx-generic-tl-wr1043nd-v1-squashfs-factory.bin
  - curl --upload-file ./bin/targets/ar71xx/generic/openwrt-ar71xx-generic-tl-wr1043nd-v1-squashfs-sysupgrade.bin https://transfer.sh/openwrt-ar71xx-generic-tl-wr1043nd-v1-squashfs-sysupgrade.bin
